{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/dpi/Desktop/_Projects/_Dev/baitlist/lib/supabase-admin.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\n\n/**\n * Server-only Supabase admin client (service role).\n * Requires SUPABASE_SERVICE_ROLE_KEY in env.\n */\nexport function createAdminClient() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY\n\n  if (!url) throw new Error('NEXT_PUBLIC_SUPABASE_URL is not set')\n  if (!serviceRoleKey) throw new Error('SUPABASE_SERVICE_ROLE_KEY is not set')\n\n  return createClient(url, serviceRoleKey, {\n    auth: {\n      persistSession: false,\n      autoRefreshToken: false,\n    },\n  })\n}\n\n"],"names":[],"mappings":";;;;AAAA;;AAMO,SAAS;IACd,MAAM;IACN,MAAM,iBAAiB,QAAQ,GAAG,CAAC,yBAAyB;IAE5D;;IACA,IAAI,CAAC,gBAAgB,MAAM,IAAI,MAAM;IAErC,OAAO,IAAA,gMAAY,EAAC,KAAK,gBAAgB;QACvC,MAAM;YACJ,gBAAgB;YAChB,kBAAkB;QACpB;IACF;AACF"}},
    {"offset": {"line": 105, "column": 0}, "map": {"version":3,"sources":["file:///Users/dpi/Desktop/_Projects/_Dev/baitlist/app/api/webhooks/stripe/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport Stripe from 'stripe'\nimport { createAdminClient } from '@/lib/supabase-admin'\n\n// Required for Stripe webhooks - prevents body parsing\nexport const runtime = 'nodejs'\n\nconst stripeSecretKey = process.env.STRIPE_SECRET_KEY\nconst webhookSecret = process.env.STRIPE_WEBHOOK_SECRET\n\n// Log at module load time to verify the route is registered\nconsole.log('[stripe-webhook] Route module loaded', {\n  hasStripeKey: !!stripeSecretKey,\n  hasWebhookSecret: !!webhookSecret,\n  timestamp: new Date().toISOString(),\n})\n\nif (!stripeSecretKey) {\n  throw new Error('STRIPE_SECRET_KEY is not set')\n}\n\nconst stripe = new Stripe(stripeSecretKey, {\n  apiVersion: '2025-12-15.clover',\n  typescript: true,\n})\n\nexport async function POST(req: NextRequest) {\n  // FIRST LOG - should appear for ANY request to this endpoint\n  console.log('[stripe-webhook] ====== WEBHOOK RECEIVED ======')\n  console.log('[stripe-webhook] Request URL:', req.url)\n  console.log('[stripe-webhook] Request method:', req.method)\n  console.log('[stripe-webhook] Timestamp:', new Date().toISOString())\n\n  if (!webhookSecret) {\n    console.error('[stripe-webhook] Missing STRIPE_WEBHOOK_SECRET')\n    return NextResponse.json({ error: 'Webhook not configured' }, { status: 500 })\n  }\n\n  const sig = req.headers.get('stripe-signature')\n  console.log('[stripe-webhook] Stripe signature present:', !!sig)\n  \n  if (!sig) {\n    console.error('[stripe-webhook] Missing stripe-signature header')\n    return NextResponse.json({ error: 'Missing signature' }, { status: 400 })\n  }\n\n  let event: Stripe.Event\n  let rawBody: string\n\n  try {\n    rawBody = await req.text()\n    console.log('[stripe-webhook] Raw body length:', rawBody.length)\n    event = stripe.webhooks.constructEvent(rawBody, sig, webhookSecret)\n    console.log('[stripe-webhook] Event verified successfully, type:', event.type)\n  } catch (err: any) {\n    console.error('[stripe-webhook] Signature verification failed:', err?.message)\n    return NextResponse.json({ error: 'Invalid signature' }, { status: 400 })\n  }\n\n  console.log('[stripe-webhook] Processing event type:', event.type)\n\n  if (event.type !== 'checkout.session.completed') {\n    console.log('[stripe-webhook] Ignoring event type:', event.type)\n    return NextResponse.json({ received: true })\n  }\n\n  try {\n    const session = event.data.object as Stripe.Checkout.Session\n    console.log('[stripe-webhook] Session ID:', session.id)\n    console.log('[stripe-webhook] Session metadata:', JSON.stringify(session.metadata))\n\n    const userId = session.metadata?.user_id\n    if (!userId) {\n      console.error('[stripe-webhook] Missing user_id in session metadata', {\n        sessionId: session.id,\n        metadata: session.metadata,\n      })\n      return NextResponse.json({ error: 'Missing user_id metadata' }, { status: 400 })\n    }\n\n    console.log('[stripe-webhook] User ID from metadata:', userId)\n\n    const customerId =\n      typeof session.customer === 'string' ? session.customer : session.customer?.id\n    const subscriptionId =\n      typeof session.subscription === 'string'\n        ? session.subscription\n        : (session.subscription as any)?.id\n\n    console.log('[stripe-webhook] Customer ID:', customerId)\n    console.log('[stripe-webhook] Subscription ID:', subscriptionId)\n\n    if (!customerId || !subscriptionId) {\n      console.error('[stripe-webhook] Missing customer/subscription on session', {\n        sessionId: session.id,\n        customerId: !!customerId,\n        subscriptionId: !!subscriptionId,\n      })\n      return NextResponse.json({ received: true })\n    }\n\n    console.log('[stripe-webhook] Creating Supabase admin client...')\n    const supabase = createAdminClient()\n\n    console.log('[stripe-webhook] Updating user_profiles where id =', userId)\n    const { data, error } = await supabase\n      .from('user_profiles')\n      .update({\n        plan_tier: 'pro',\n        signup_limit: 1000,\n        stripe_customer_id: customerId,\n        stripe_subscription_id: subscriptionId,\n        updated_at: new Date().toISOString(),\n      })\n      .eq('id', userId)\n      .select()\n\n    if (error) {\n      console.error('[stripe-webhook] Supabase update failed:', error)\n      return NextResponse.json({ error: 'Database update failed' }, { status: 500 })\n    }\n\n    console.log('[stripe-webhook] Supabase update result:', JSON.stringify(data))\n    console.log('[stripe-webhook] ====== SUCCESS: User upgraded to pro ======', {\n      userId,\n      customerId,\n      subscriptionId,\n      sessionId: session.id,\n    })\n\n    return NextResponse.json({ received: true })\n  } catch (err: any) {\n    console.error('[stripe-webhook] Handler error:', err?.message || err)\n    return NextResponse.json({ error: 'Webhook handler failed' }, { status: 500 })\n  }\n}\n\n// GET handler for testing if the route is accessible\nexport async function GET() {\n  console.log('[stripe-webhook] GET request received - route is accessible')\n  return NextResponse.json({ \n    status: 'Webhook endpoint is accessible',\n    hasWebhookSecret: !!webhookSecret,\n    timestamp: new Date().toISOString(),\n  })\n}\n\n"],"names":[],"mappings":"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"}}]
}